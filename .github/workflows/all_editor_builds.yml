name: ðŸ¤– Build Godot for All Platforms
on:
  workflow_call:

# Global Settings
# SCONS_CACHE for windows must be set in the build environment
env:
  SCONSFLAGS: verbose=yes warnings=all werror=no module_text_server_fb_enabled=yes minizip=yes deprecated=yes module_patchwork_editor_enabled=yes

concurrency:
  group: ci-${{github.actor}}-${{github.head_ref || github.run_number}}-${{github.ref}}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ðŸªŸ Build Godot for Windows"
            os: "windows-latest"
            id: windows-editor
            platform: windows
            target: editor
            sconsflags: tests=yes debug_symbols=yes
            bin: ./bin/godot.windows.editor.x86_64.exe

          - name: "ðŸ§ Build Godot for Linux"
            os: "ubuntu-22.04"
            id: linux-editor
            platform: linux
            target: editor
            sconsflags: tests=yes
            sconsflags-template: optimize=size use_lto=yes debug_symbols=no
            bin: ./bin/godot.linuxbsd.editor.x86_64

          - name: "ðŸŽ Build Godot for macOS"
            os: "macos-14"
            id: macos-editor
            platform: macos
            target: editor
            sconsflags: tests=yes use_volk=no vulkan_sdk_path=$VULKAN_SDK_PATH use_lto=yes debug_symbols=no
            bin: ./bin/godot.macos.editor.arm64

    steps:
      - name: Checkout patchwork-godot-plugin
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Grab the environment variables from build.env and output them
      - name: Fetch env variables
        id: dotenv
        uses: falti/dotenv-action@v1.1.5
        with:
          path: build.env
          keys-case: bypass

      - name: Checkout Godot
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.dotenv.outputs.GODOT_REPO }}
          ref: ${{ steps.dotenv.outputs.GODOT_REF }}
          path: build/godot

      - name: Copy editor directory
        shell: bash
        run: |
          cp -R editor build/godot/modules/patchwork_editor

      - name: Select Xcode 16
        if: matrix.platform == 'macos'
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Restore Godot build cache
        uses: ./build/godot/.github/actions/godot-cache-restore
        id: restore-cache
        with:
          cache-name: ${{ matrix.id }}-${{ matrix.target }}
        continue-on-error: true

      - name: Install Linux deps
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install build-essential pkg-config libx11-dev libxcursor-dev \
            libxinerama-dev libgl1-mesa-dev libglu-dev libasound2-dev libpulse-dev \
            libudev-dev libxi-dev libxrandr-dev yasm clang-format libwayland-bin
          sudo apt-get install libwayland-bin

      - name: Setup python and scons
        working-directory: build/godot
        uses: ./build/godot/.github/actions/godot-deps

      - name: Download Direct3D 12 SDK components
        shell: sh
        id: d3d12-sdk
        if: matrix.platform == 'windows'
        run: |
          if python build/godot/misc/scripts/install_d3d12_sdk_windows.py; then
            echo "D3D12_ENABLED=yes" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::Windows: Direct3D 12 SDK installation failed, building without Direct3D 12 support."
            echo "D3D12_ENABLED=no" >> "$GITHUB_OUTPUT"
          fi
        continue-on-error: true

      - name: Setup Vulkan SDK
        if: matrix.platform == 'macos'
        run: |
          sh build/godot/misc/scripts/install_vulkan_sdk_macos.sh

      - name: Compile Editor (x86_64)
        if: matrix.target == 'editor'
        id: compile-editor
        uses: ./build/godot/.github/actions/godot-build
        with:
          scons-flags: arch=x86_64 ${{ env.SCONSFLAGS }} ${{ matrix.sconsflags }}
          platform: ${{ matrix.platform }}
          target: editor

      - name: Compile Editor for macos arm64
        uses: ./build/godot/.github/actions/godot-build
        if: matrix.platform == 'macos' && matrix.target == 'editor'
        with:
          # generate the bundle on this one; generate_bundle automatically lipos the binaries
          scons-flags: arch=arm64 ${{ env.SCONSFLAGS }} ${{ matrix.sconsflags }} generate_bundle=yes
          platform: ${{ matrix.platform }}
          target: editor

      - name: cleanup macos
        if: matrix.platform == 'macos' && matrix.target == 'editor'
        shell: bash
        run: |
          rm -f build/godot/bin/godot.macos.*
          chmod +x build/godot/bin/godot_macos_editor.app/Contents/MacOS/Godot

      - name: Prepare artifact
      # Stripping the debug symbols screws up lipo'd binaries on macos, so don't do it
        if: matrix.platform != 'macos'
        uses: ./.github/actions/godot-prepare-artifact

      - name: Save Godot build cache
        # if: success() || (steps.restore-cache.outputs.cache-hit == 'false' && (steps.compile-editor.outcome != 'skipped' || steps.compile-template.outcome != 'skipped'))
        uses: ./build/godot/.github/actions/godot-cache-save
        with:
          cache-name: ${{ matrix.id }}-${{ matrix.target }}
        continue-on-error: true

      # Mac set permissions
      - name: Mac set permissions
        if: matrix.platform == 'macos' && matrix.target == 'editor'
        shell: bash
        run: |
          chmod +x build/godot/bin/godot_macos_editor.app/Contents/MacOS/Godot

      - name: Mac Sign
        if: matrix.platform == 'macos' && matrix.target == 'editor'
        uses: ./.github/actions/macos-sign
        with:
          FRAMEWORK_PATH: ${{ github.workspace }}/build/godot/bin/godot_macos_editor.app
          SIGN_FLAGS: "--deep --force --options=runtime --entitlements ${{ github.workspace }}/build/godot/misc/dist/macos/editor.entitlements"
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
          APPLE_DEV_PASSWORD: ${{ secrets.APPLE_DEV_PASSWORD }}
          APPLE_DEV_ID: ${{ secrets.APPLE_DEV_ID }}
          APPLE_DEV_TEAM_ID: ${{ secrets.APPLE_DEV_TEAM_ID }}
          APPLE_DEV_APP_ID: ${{ secrets.APPLE_DEV_APP_ID }}
          BUNDLE_IDENTIFIER_OVERRIDE: "com.inkandswitch.patchworkgodoteditor"

      - uses: actions/upload-artifact@v4
        if: matrix.id != 'linux-sanitizers'
        with:
          name: godot-with-patchwork-${{ matrix.platform }}
          path: build/godot/bin/*
          retention-days: 90
