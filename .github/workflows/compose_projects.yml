name: üßµ Compose Projects
on:
  workflow_call:

jobs:
  retrieve-env:
    name: üîç Load Environment variables
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
    outputs:
      THREADBARE_REPO: ${{ steps.dotenv.outputs.THREADBARE_REPO }}
      THREADBARE_REF: ${{ steps.dotenv.outputs.THREADBARE_REF }}
      MODDABLE_PLATFORMER_REPO: ${{ steps.dotenv.outputs.MODDABLE_PLATFORMER_REPO }}
      MODDABLE_PLATFORMER_REF: ${{ steps.dotenv.outputs.MODDABLE_PLATFORMER_REF }}
    steps:
      - uses: actions/checkout@v4
      - id: dotenv
        uses: falti/dotenv-action@v1.1.5
        with:
          path: build.env
          log-variables: true
          keys-case: bypass

  compose-projects:
    needs: [retrieve-env]
    runs-on: "ubuntu-latest"
    name: ü™° Compose ${{ matrix.project.name }}
    strategy:
      fail-fast: false
      matrix:
        project:
          - name: threadbare
            repo: ${{ needs.retrieve-env.outputs.THREADBARE_REPO }}
            ref: ${{ needs.retrieve-env.outputs.THREADBARE_REF }}
          - name: moddable-platformer
            repo: ${{ needs.retrieve-env.outputs.MODDABLE_PLATFORMER_REPO }}
            ref: ${{ needs.retrieve-env.outputs.MODDABLE_PLATFORMER_REF }}
    steps:
      - shell: sh
        run: |
          echo "'${{ toJSON(needs) }}'"
          
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.repo }}
          ref: ${{ matrix.project.ref }}
          path: ${{ matrix.project.name }}
          fetch-depth: 0
          persist-credentials: false
      - name: Download Patchwork
        uses: actions/download-artifact@v7
        with:
          pattern: patchwork-godot-plugin
          path: patchwork-godot-plugin
      - name: Copy to addons
        shell: sh
        run: |
          mkdir -p ${{ matrix.project.name }}/addons/patchwork |
          cp -r patchwork-godot-plugin/* ${{ matrix.project.name }}/addons/patchwork
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.name }}-with-patchwork
          path: |
            ${{ matrix.project.name }}
          if-no-files-found: error

