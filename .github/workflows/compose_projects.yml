name: ðŸ§µ Compose Projects
on:
  workflow_call:

jobs:
  retrieve-env:
    name: ðŸ” Load Environment variables
    runs-on: "ubuntu-latest"
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: aarcangeli/load-dotenv@v1
        with:
          filenames: build.env
      - run: echo "matrix={\"project\":[{\"name\":\"threadbare\",\"repo\":\"${{ env.THREADBARE_REPO }}\",\"ref\":\"${{ env.THREADBARE_REF }}\"},{\"name\":\"moddable-platformer\",\"repo\":\"${{ env.MODDABLE_PLATFORMER_REPO }}\",\"ref\":\"${{ env.MODDABLE_PLATFORMER_REF }}\"}]}" >> $GITHUB_OUTPUT

  compose-projects:
    runs-on: "ubuntu-latest"
    name: ðŸª¡ Compose ${{ matrix.project.name }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.retrieve-env.outputs.matrix) }}
    steps:
      - name: Checkout project
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.project.repo }}
          ref: ${{ matrix.project.ref }}
          path: ${{ matrix.project.name }}
          fetch-depth: 0
          persist-credentials: false
      - name: Download Patchwork
        uses: actions/download-artifact@v7
        with:
          pattern: patchwork-godot-plugin
          path: patchwork-godot-plugin
      - name: Copy to addons
        shell: sh
        run: |
          mkdir -p ${{ matrix.project.name }}/addons/patchwork |
          cp -r patchwork-godot-plugin/* ${{ matrix.project.name }}/addons/patchwork
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project.name }}-with-patchwork
          path: |
            ${{ matrix.project.name }}
          if-no-files-found: error

